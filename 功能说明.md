# 试题模块管理功能说明

## 功能概述

本系统支持在 Django 后台管理界面中，根据选择的试题模块类型，显示对应题库的所有试题，并支持灵活的关联管理。

## 数据关系图

```
试卷 (ExamPaper)
    ↓ (多对多)
试题模块 (ExamModule)
    ↓ (多对多)
具体题目 (根据模块类型)
    - LISTENING_MCQ → McqQuestion (听力选择题)
    - STORY_RETELL → RetellItem (故事复述题)
    - LISTENING_SA → LsaDialog (听力简答题)
    - OPI → OpiTopic (OPI话题)
    - ATC_SIM → AtcScenario (ATC场景)
```

## 功能特点

### 1. 智能题目显示

后台会根据选择的模块类型，自动显示对应的题目类型：

| 模块类型 | 显示的题目类型 | 说明 |
|---------|--------------|------|
| 听力理解 (LISTENING_MCQ) | 听力选择题 (McqQuestion) | 包含音频的单选题 |
| 故事复述 (STORY_RETELL) | 复述题目 (RetellItem) | 听音频后复述 |
| 听力简答 (LISTENING_SA) | 听力简答对话 (LsaDialog) | 听对话后回答问题 |
| 口语面试 (OPI) | OPI话题 (OpiTopic) | 口语面试话题及问题 |
| 模拟通话 (ATC_SIM) | ATC场景 (AtcScenario) | 空中交通管制场景 |

### 2. 双向关联管理

**从模块到题目**:
- 在 ExamModule 详情页查看所有关联的题目
- 显示题目列表、数量统计
- 提供快捷链接跳转到题目管理

**从题目到模块**:
- 在题目详情页使用 `filter_horizontal` 多选关联模块
- 一道题可以关联到多个模块（题目复用）
- 在题目列表页可以按模块筛选

### 3. 可视化界面

ExamModule 详情页会显示：

```
┌─────────────────────────────────────────────────┐
│ 📝 听力选择题                共 5 道题            │
├─────────────────────────────────────────────────┤
│ ID  │ 标题                        │ 操作        │
├─────┼─────────────────────────────┼────────────┤
│ 1   │ MCQ Question 1              │ [编辑]     │
│ 2   │ MCQ Question 2              │ [编辑]     │
│ ... │ ...                         │ ...        │
├─────────────────────────────────────────────────┤
│ [查看所有关联题目]  [添加新题目]                 │
└─────────────────────────────────────────────────┘
```

## 操作流程示例

### 场景：创建一个包含 5 道听力选择题的模块

#### 步骤 1: 创建试题模块
1. 后台 → 试题模块 → 添加
2. 填写信息：
   - 标题: "Part 1 - 听力理解"
   - 模块类型: 选择 "听力理解 (LISTENING_MCQ)"
   - 显示顺序: 1
   - 分数: 100
   - 时长: 600000 (10分钟，单位毫秒)
3. 保存

#### 步骤 2: 准备题目（两种方式）

**方式 A: 先创建题目，再关联模块**
1. 后台 → 听力选择题 → 添加
2. 创建 5 道题目（每道题会默认显示 4 个选项 A、B、C、D）
3. 在每道题的"关联模块"中，选择刚创建的"Part 1 - 听力理解"
4. 保存所有题目

**方式 B: 从模块页面跳转创建题目**
1. 编辑刚创建的"Part 1 - 听力理解"模块
2. 在"关联试题"区域，点击"添加新题目"按钮
3. 系统打开新窗口，创建听力选择题
4. 在"关联模块"中会看到当前模块，选中它
5. 保存题目（重复 5 次）

#### 步骤 3: 验证关联
1. 返回"Part 1 - 听力理解"模块详情页
2. 在"关联试题"区域应该看到：
   - "共 5 道题"
   - 5 道题的列表（ID、标题、编辑链接）
3. 点击"查看所有关联题目"可以看到筛选后的题目列表

#### 步骤 4: 将模块添加到试卷
1. 后台 → 考试试卷 → 选择或创建试卷
2. 在试卷的"关联模块"中，选择"Part 1 - 听力理解"
3. 保存试卷

## MCQ 题目创建优化

### 默认 4 个选项

现在创建 MCQ 题目时：
- ✅ 默认显示 4 个空白选项表单
- ✅ 选项标签自动设置为 A、B、C、D
- ✅ 只需填写选项内容并勾选正确答案
- ✅ 最多可以有 4 个选项

示例界面：
```
选项:
┌──────────────────────────────────────────────┐
│ 标签: A  内容: [____________]  ☐ 是否正确答案 │
│ 标签: B  内容: [____________]  ☐ 是否正确答案 │
│ 标签: C  内容: [____________]  ☐ 是否正确答案 │
│ 标签: D  内容: [____________]  ☐ 是否正确答案 │
└──────────────────────────────────────────────┘
```

## 注意事项

1. **保存顺序**: 必须先保存试题模块，才能在详情页看到关联的题目
2. **多对多关系**: 一道题可以属于多个模块，方便题目复用
3. **题目数量**: 关联题目列表最多显示 20 条，更多的需要点击"查看所有关联题目"
4. **时长单位**: 模块时长使用毫秒为单位（例如：10分钟 = 600000 毫秒）
5. **ATC 特殊**: ATC 场景使用 ForeignKey 关系（一个场景只能属于一个模块）

## 技术实现

- 使用 Django Admin 的 `readonly_fields` 实现自定义显示
- 使用 `filter_horizontal` 实现多对多关系的水平选择器
- 使用 `mark_safe` 渲染 HTML 界面
- 根据 `module_type` 动态查询不同的 related_name

